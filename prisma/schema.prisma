// Prisma Schema for FluX Ticket Bot v2.0
// Supports: SQLite (development) and PostgreSQL (production)

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "sqlite"
    url      = env("DATABASE_URL")
}

// ==================== GUILD MODEL ====================
model Guild {
    id                   String    @id
    name                 String
    
    // Ticket Settings
    categoryId           String?
    panelChannelId       String?
    panelMessageId       String?
    logChannelId         String?
    staffRoles           String?
    ticketCount          Int       @default(0)
    
    // Advanced Settings
    maxTicketsPerUser    Int       @default(3)
    autoCloseHours       Int       @default(48)
    welcomeMessage       String?
    closeMessage         String?
    locale               String    @default("tr")
    
    // Notifications
    dmNotifications      Boolean   @default(true)
    dmOnStaffReply       Boolean   @default(false)
    webhookUrl           String?
    
    // Relations
    tickets              Ticket[]
    categories           Category[]
    cannedResponses      CannedResponse[]
    stats                GuildStats?
    
    // Timestamps
    createdAt            DateTime  @default(now())
    updatedAt            DateTime  @updatedAt
}

// ==================== CATEGORY MODEL ====================
model Category {
    id                   String    @id @default(cuid())
    guildId              String
    guild                Guild     @relation(fields: [guildId], references: [id], onDelete: Cascade)
    
    name                 String
    description          String?
    emoji                String?   @default("ðŸŽ«")
    color                String?   @default("#5865F2")
    
    discordCategoryId    String?
    staffRoles           String?
    
    enabled              Boolean   @default(true)
    order                Int       @default(0)
    
    tickets              Ticket[]
    
    createdAt            DateTime  @default(now())
    updatedAt            DateTime  @updatedAt
    
    @@unique([guildId, name])
}

// ==================== TICKET MODEL ====================
model Ticket {
    id                   String    @id @default(cuid())
    ticketNumber         Int
    channelId            String    @unique
    
    guildId              String
    guild                Guild     @relation(fields: [guildId], references: [id], onDelete: Cascade)
    categoryId           String?
    category             Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
    
    userId               String
    subject              String?
    description          String?
    
    status               String    @default("open")
    priority             Int       @default(1)
    tags                 String?
    
    claimedBy            String?
    claimedAt            DateTime?
    closedBy             String?
    closeReason          String?
    closedAt             DateTime?
    
    // Scheduled Close
    scheduledCloseAt     DateTime?
    scheduledCloseBy     String?
    scheduledCloseReason String?
    
    // Metrics
    messageCount         Int       @default(0)
    rating               Int?
    transcriptUrl        String?
    
    lastActivity         DateTime  @default(now())
    
    createdAt            DateTime  @default(now())
    updatedAt            DateTime  @updatedAt
    
    @@index([guildId, status])
    @@index([guildId, userId])
    @@index([lastActivity])
    @@index([scheduledCloseAt])
}

// ==================== USER MODEL ====================
model User {
    id                   String    @id
    username             String
    
    blacklisted          Boolean   @default(false)
    blacklistReason      String?
    
    totalTickets         Int       @default(0)
    
    createdAt            DateTime  @default(now())
    updatedAt            DateTime  @updatedAt
}

// ==================== GUILD STATS MODEL ====================
model GuildStats {
    id                   String    @id @default(cuid())
    guildId              String    @unique
    guild                Guild     @relation(fields: [guildId], references: [id], onDelete: Cascade)
    
    totalTickets         Int       @default(0)
    openTickets          Int       @default(0)
    closedTickets        Int       @default(0)
    
    averageResponseTime  Float?
    averageCloseTime     Float?
    averageRating        Float?
    
    createdAt            DateTime  @default(now())
    updatedAt            DateTime  @updatedAt
}

// ==================== CANNED RESPONSE MODEL ====================
model CannedResponse {
    id                   String    @id @default(cuid())
    guildId              String
    guild                Guild     @relation(fields: [guildId], references: [id], onDelete: Cascade)
    
    name                 String
    content              String
    
    createdBy            String
    useCount             Int       @default(0)
    
    createdAt            DateTime  @default(now())
    updatedAt            DateTime  @updatedAt
    
    @@unique([guildId, name])
}

// ==================== API KEY MODEL ====================
model ApiKey {
    id                   String    @id @default(cuid())
    guildId              String
    
    key                  String    @unique
    name                 String
    permissions          String    @default("read")
    
    lastUsed             DateTime?
    usageCount           Int       @default(0)
    
    enabled              Boolean   @default(true)
    expiresAt            DateTime?
    
    createdAt            DateTime  @default(now())
    updatedAt            DateTime  @updatedAt
    
    @@index([guildId])
}
