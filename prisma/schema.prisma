// Prisma Schema for FluX Ticket Bot v2.1
// PostgreSQL version (for production)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Guild (Sunucu) Ayarları
model Guild {
  id                  String    @id // Discord Guild ID
  name                String
  categoryId          String?   // Ticket kategorisi ID (Discord)
  panelChannelId      String?   // Panel mesajının olduğu kanal
  panelMessageId      String?   // Panel mesajının ID'si
  logChannelId        String?   // Log kanalı
  transcriptChannelId String?   // Transcript kanalı
  staffRoles          String    @default("") // Yetkili roller (virgülle ayrılmış)
  ticketCount         Int       @default(0) // Toplam açılan ticket sayısı
  premium             Boolean   @default(false) // Premium özellikler
  locale              String    @default("tr") // Dil ayarı
  maxTicketsPerUser   Int       @default(3) // Kullanıcı başına max ticket
  autoCloseHours      Int       @default(48) // Otomatik kapatma süresi (saat)
  dmNotifications     Boolean   @default(true) // DM bildirimleri
  webhookUrl          String?   // Discord webhook URL
  welcomeMessage      String?   // Özel karşılama mesajı
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  tickets             Ticket[]
  categories          Category[]
  stats               GuildStats?
  cannedResponses     CannedResponse[]
  apiKeys             ApiKey[]
  transcripts         Transcript[]
}

// Ticket Kategorileri (Destek, Satış, Şikayet vs.)
model Category {
  id                  String   @id @default(cuid())
  guildId             String
  name                String   // Kategori adı (Destek, Satış, etc.)
  emoji               String?  // Emoji
  description         String?
  staffRoles          String   @default("") // Bu kategoriye özel yetkili roller
  color               String   @default("#5865F2") // Embed rengi
  discordCategoryId   String?  // Discord'daki kategori ID'si
  enabled             Boolean  @default(true)
  order               Int      @default(0) // Sıralama
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  guild               Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  tickets             Ticket[]
  
  @@unique([guildId, name])
  @@index([guildId])
}

// Ticket
model Ticket {
  id                    String    @id @default(cuid())
  ticketNumber          Int       // #0001, #0002 formatında
  channelId             String    @unique // Discord kanal ID
  guildId               String
  categoryId            String?   // Hangi kategoriye ait
  userId                String    // Ticketı açan kullanıcı
  userName              String?   // Kullanıcı adı (cache)
  subject               String?   // Konu
  description           String?   // Açıklama
  status                String    @default("open") // open, claimed, closed, archived
  priority              Int       @default(1) // 1: düşük, 2: orta, 3: yüksek, 4: acil
  claimedBy             String?   // Ticketı sahiplenen yetkili
  claimedByName         String?   // Yetkili adı (cache)
  closedBy              String?   // Ticketı kapatan kişi
  closedByName          String?   // Kapatan adı (cache)
  closeReason           String?   // Kapanış sebebi
  rating                Int?      // 1-5 arası memnuniyet puanı
  ratingFeedback        String?   // Değerlendirme yorumu
  tags                  String    @default("") // Etiketler (virgülle ayrılmış)
  messageCount          Int       @default(0) // Mesaj sayısı
  firstResponseAt       DateTime? // İlk yanıt zamanı
  scheduledCloseAt      DateTime? // Zamanlanmış kapatma
  scheduledCloseBy      String?   // Zamanlamayı yapan
  scheduledCloseReason  String?   // Zamanlanmış kapatma sebebi
  createdAt             DateTime  @default(now())
  claimedAt             DateTime?
  closedAt              DateTime?
  lastActivity          DateTime  @default(now()) // Son aktivite (auto-close için)
  
  guild                 Guild     @relation(fields: [guildId], references: [id], onDelete: Cascade)
  category              Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  transcript            Transcript?
  
  @@unique([guildId, ticketNumber])
  @@index([guildId, status])
  @@index([userId])
  @@index([claimedBy])
}

// Transcript
model Transcript {
  id            String   @id @default(cuid())
  ticketId      String   @unique
  guildId       String
  ticketNumber  Int
  userId        String   // Ticket sahibi
  userName      String?
  closedBy      String?
  closedByName  String?
  channelName   String?
  messageCount  Int      @default(0)
  htmlContent   String   // HTML içerik (büyük metin)
  createdAt     DateTime @default(now())
  closedAt      DateTime @default(now())
  
  ticket        Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  guild         Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  
  @@index([guildId])
  @@index([ticketNumber])
}

// Guild İstatistikleri (Dashboard için)
model GuildStats {
  id                    String   @id @default(cuid())
  guildId               String   @unique
  totalTickets          Int      @default(0)
  openTickets           Int      @default(0)
  closedTickets         Int      @default(0)
  averageResponseTime   Int      @default(0) // Dakika cinsinden
  averageCloseTime      Int      @default(0) // Dakika cinsinden
  averageRating         Float?   // Ortalama memnuniyet puanı
  totalRatings          Int      @default(0)
  updatedAt             DateTime @updatedAt
  
  guild                 Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
}

// Kullanıcı Verileri (Blacklist, Geçmiş vs.)
model User {
  id              String   @id // Discord User ID
  username        String
  globalName      String?
  avatarUrl       String?
  blacklisted     Boolean  @default(false)
  blacklistReason String?
  blacklistedBy   String?
  blacklistedAt   DateTime?
  totalTickets    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Canned Responses (Hazır Yanıtlar)
model CannedResponse {
  id              String   @id @default(cuid())
  guildId         String
  name            String   // Kısa isim (örn: "selam", "hoşgeldin")
  content         String   // Yanıt içeriği
  createdBy       String   // Oluşturan yetkili
  createdByName   String?
  useCount        Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  guild           Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  
  @@unique([guildId, name])
  @@index([guildId])
}

// API Keys (Dashboard erişimi için)
model ApiKey {
  id          String   @id @default(cuid())
  guildId     String
  key         String   @unique // ftk_xxxxx formatında
  name        String   // Anahtar ismi
  permissions String   @default("read") // read, read,write, admin
  enabled     Boolean  @default(true)
  usageCount  Int      @default(0)
  lastUsed    DateTime?
  createdBy   String   // Oluşturan kullanıcı
  createdAt   DateTime @default(now())
  expiresAt   DateTime? // Opsiyonel son kullanma tarihi
  
  guild       Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  
  @@index([guildId])
  @@index([key])
}

// Audit Log (İşlem geçmişi)
model AuditLog {
  id          String   @id @default(cuid())
  guildId     String
  action      String   // TICKET_CREATE, TICKET_CLOSE, USER_BLACKLIST vs.
  targetType  String   // TICKET, USER, CATEGORY, SYSTEM
  targetId    String?  // İlgili kayıt ID'si
  userId      String   // İşlemi yapan
  userName    String?
  details     String?  // JSON formatında ek detaylar
  createdAt   DateTime @default(now())
  
  @@index([guildId])
  @@index([action])
  @@index([userId])
}
