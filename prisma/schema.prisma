// Prisma Schema for FluX Ticket Bot
// Supports: SQLite (development) and PostgreSQL (production)

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "sqlite" // Change to "postgresql" for production
    url      = env("DATABASE_URL")
}

// ==================== GUILD MODEL ====================
model Guild {
    id                 String    @id // Discord Guild ID
    name               String
    
    // Ticket Settings
    categoryId         String?   // Discord Category ID for tickets
    panelChannelId     String?   // Channel where ticket panel is sent
    panelMessageId     String?   // The panel message ID
    logChannelId       String?   // Channel for ticket logs
    staffRoles         String?   // Comma-separated role IDs
    ticketCount        Int       @default(0) // Auto-increment ticket number
    
    // Optional Settings
    maxTicketsPerUser  Int       @default(3)
    autoCloseHours     Int       @default(48)
    welcomeMessage     String?   // Custom welcome message
    closeMessage       String?   // Custom close message
    
    // Relations
    tickets            Ticket[]
    categories         Category[]
    cannedResponses    CannedResponse[]
    stats              GuildStats?
    
    // Timestamps
    createdAt          DateTime  @default(now())
    updatedAt          DateTime  @updatedAt
}

// ==================== CATEGORY MODEL ====================
model Category {
    id                 String    @id @default(cuid())
    guildId            String
    guild              Guild     @relation(fields: [guildId], references: [id], onDelete: Cascade)
    
    // Category Info
    name               String
    description        String?
    emoji              String?   @default("ðŸŽ«")
    color              String?   @default("#5865F2")
    
    // Discord Integration
    discordCategoryId  String?   // Separate Discord category for this type
    staffRoles         String?   // Category-specific staff roles (comma-separated)
    
    // Settings
    enabled            Boolean   @default(true)
    order              Int       @default(0)
    
    // Relations
    tickets            Ticket[]
    
    // Timestamps
    createdAt          DateTime  @default(now())
    updatedAt          DateTime  @updatedAt
    
    @@unique([guildId, name])
}

// ==================== TICKET MODEL ====================
model Ticket {
    id                 String    @id @default(cuid())
    ticketNumber       Int       // Guild-specific ticket number
    channelId          String    @unique // Discord Channel ID
    
    // Relations
    guildId            String
    guild              Guild     @relation(fields: [guildId], references: [id], onDelete: Cascade)
    categoryId         String?
    category           Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
    
    // User Info
    userId             String    // Ticket creator's Discord ID
    
    // Ticket Status
    status             String    @default("open") // open, claimed, closed
    priority           Int       @default(1) // 1-4 (low, medium, high, urgent)
    tags               String?   // Comma-separated tags
    
    // Staff Info
    claimedBy          String?   // Staff member who claimed
    claimedAt          DateTime?
    closedBy           String?   // Who closed the ticket
    closeReason        String?
    closedAt           DateTime?
    
    // Metrics
    messageCount       Int       @default(0)
    rating             Int?      // 1-5 star rating
    transcriptUrl      String?   // URL to transcript file
    
    // Activity Tracking
    lastActivity       DateTime  @default(now())
    
    // Timestamps
    createdAt          DateTime  @default(now())
    updatedAt          DateTime  @updatedAt
    
    @@index([guildId, status])
    @@index([guildId, userId])
    @@index([lastActivity])
}

// ==================== USER MODEL ====================
model User {
    id                 String    @id // Discord User ID
    username           String
    
    // Blacklist
    blacklisted        Boolean   @default(false)
    blacklistReason    String?
    
    // Stats
    totalTickets       Int       @default(0)
    
    // Timestamps
    createdAt          DateTime  @default(now())
    updatedAt          DateTime  @updatedAt
}

// ==================== GUILD STATS MODEL ====================
model GuildStats {
    id                 String    @id @default(cuid())
    guildId            String    @unique
    guild              Guild     @relation(fields: [guildId], references: [id], onDelete: Cascade)
    
    // Ticket Counts
    totalTickets       Int       @default(0)
    openTickets        Int       @default(0)
    closedTickets      Int       @default(0)
    
    // Performance Metrics
    averageResponseTime Float?   // In minutes
    averageCloseTime    Float?   // In minutes
    averageRating       Float?   // 1-5
    
    // Timestamps
    createdAt          DateTime  @default(now())
    updatedAt          DateTime  @updatedAt
}

// ==================== CANNED RESPONSE MODEL ====================
model CannedResponse {
    id                 String    @id @default(cuid())
    guildId            String
    guild              Guild     @relation(fields: [guildId], references: [id], onDelete: Cascade)
    
    // Response Info
    name               String    // Short identifier
    content            String    // The actual response text
    
    // Metadata
    createdBy          String    // Discord User ID
    useCount           Int       @default(0)
    
    // Timestamps
    createdAt          DateTime  @default(now())
    updatedAt          DateTime  @updatedAt
    
    @@unique([guildId, name])
}
