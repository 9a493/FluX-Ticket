<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FluX Ticket Dashboard v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sidebar { transition: transform 0.3s ease; }
        .card { transition: all 0.2s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div id="app"></div>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect, createContext, useContext, useRef } = React;

        // API Context
        const ApiContext = createContext();
        
        function ApiProvider({ children }) {
            const [apiUrl, setApiUrl] = useState(localStorage.getItem('apiUrl') || '');
            const [apiKey, setApiKey] = useState(localStorage.getItem('apiKey') || '');
            const [isAuth, setIsAuth] = useState(false);

            const api = async (endpoint, options = {}) => {
                const res = await fetch(`${apiUrl}${endpoint}`, {
                    ...options,
                    headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json', ...options.headers }
                });
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                return res.json();
            };

            const login = async (url, key) => {
                try {
                    const res = await fetch(`${url}/api/health`);
                    if (res.ok) {
                        setApiUrl(url);
                        setApiKey(key);
                        localStorage.setItem('apiUrl', url);
                        localStorage.setItem('apiKey', key);
                        setIsAuth(true);
                        return true;
                    }
                } catch (e) { console.error(e); }
                return false;
            };

            const logout = () => {
                localStorage.removeItem('apiUrl');
                localStorage.removeItem('apiKey');
                setIsAuth(false);
            };

            useEffect(() => {
                if (apiUrl && apiKey) {
                    api('/api/health').then(() => setIsAuth(true)).catch(() => setIsAuth(false));
                }
            }, []);

            return <ApiContext.Provider value={{ api, login, logout, isAuth, apiUrl }}>{children}</ApiContext.Provider>;
        }

        const useApi = () => useContext(ApiContext);

        // Login Page
        function LoginPage() {
            const [url, setUrl] = useState('http://localhost:3000');
            const [key, setKey] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const { login } = useApi();

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                const success = await login(url, key);
                if (!success) setError('BaÄŸlantÄ± baÅŸarÄ±sÄ±z!');
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center gradient-bg">
                    <div className="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="text-5xl mb-4">ğŸ«</div>
                            <h1 className="text-2xl font-bold">FluX Ticket</h1>
                            <p className="text-gray-400">Dashboard v3.0</p>
                        </div>
                        <form onSubmit={handleLogin}>
                            <div className="mb-4">
                                <label className="block text-sm mb-2">API URL</label>
                                <input type="text" value={url} onChange={e => setUrl(e.target.value)}
                                    className="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-purple-500 outline-none"/>
                            </div>
                            <div className="mb-6">
                                <label className="block text-sm mb-2">API Key</label>
                                <input type="password" value={key} onChange={e => setKey(e.target.value)} placeholder="ftk_..."
                                    className="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-purple-500 outline-none"/>
                            </div>
                            {error && <p className="text-red-400 text-sm mb-4">{error}</p>}
                            <button type="submit" disabled={loading}
                                className="w-full py-3 rounded-lg gradient-bg font-semibold hover:opacity-90 transition">
                                {loading ? 'BaÄŸlanÄ±yor...' : 'GiriÅŸ Yap'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // Sidebar
        function Sidebar({ active, setActive }) {
            const { logout } = useApi();
            const items = [
                { id: 'dashboard', icon: 'fa-chart-line', label: 'Dashboard' },
                { id: 'tickets', icon: 'fa-ticket', label: 'Ticketlar' },
                { id: 'staff', icon: 'fa-users', label: 'Staff' },
                { id: 'kb', icon: 'fa-book', label: 'Bilgi BankasÄ±' },
                { id: 'settings', icon: 'fa-cog', label: 'Ayarlar' },
            ];

            return (
                <div className="sidebar w-64 bg-gray-800 h-screen fixed left-0 top-0 p-4 flex flex-col">
                    <div className="flex items-center gap-3 mb-8 p-2">
                        <div className="text-3xl">ğŸ«</div>
                        <div>
                            <h1 className="font-bold">FluX Ticket</h1>
                            <p className="text-xs text-gray-400">v3.0 MEGA</p>
                        </div>
                    </div>
                    <nav className="flex-1">
                        {items.map(item => (
                            <button key={item.id} onClick={() => setActive(item.id)}
                                className={`w-full flex items-center gap-3 p-3 rounded-lg mb-2 transition ${
                                    active === item.id ? 'bg-purple-600' : 'hover:bg-gray-700'
                                }`}>
                                <i className={`fas ${item.icon}`}></i>
                                <span>{item.label}</span>
                            </button>
                        ))}
                    </nav>
                    <button onClick={logout} className="flex items-center gap-3 p-3 rounded-lg hover:bg-red-500/20 text-red-400">
                        <i className="fas fa-sign-out-alt"></i>
                        <span>Ã‡Ä±kÄ±ÅŸ</span>
                    </button>
                </div>
            );
        }

        // Chart Component
        function Chart({ type, data, options }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (chartRef.current) chartRef.current.destroy();
                chartRef.current = new window.Chart(canvasRef.current, { type, data, options });
                return () => chartRef.current?.destroy();
            }, [data]);

            return <canvas ref={canvasRef}></canvas>;
        }

        // Dashboard Page
        function DashboardPage() {
            const { api } = useApi();
            const [stats, setStats] = useState(null);
            const [daily, setDaily] = useState([]);
            const [leaderboard, setLeaderboard] = useState([]);

            useEffect(() => {
                api('/api/stats').then(setStats).catch(console.error);
                api('/api/stats/daily?days=14').then(setDaily).catch(console.error);
                api('/api/stats/leaderboard?type=tickets&limit=5').then(setLeaderboard).catch(console.error);
            }, []);

            const chartData = {
                labels: daily.map(d => new Date(d.date).toLocaleDateString('tr-TR', { day: '2-digit', month: 'short' })),
                datasets: [
                    { label: 'AÃ§Ä±lan', data: daily.map(d => d.ticketsOpened), borderColor: '#10B981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4, fill: true },
                    { label: 'KapatÄ±lan', data: daily.map(d => d.ticketsClosed), borderColor: '#8B5CF6', backgroundColor: 'rgba(139, 92, 246, 0.1)', tension: 0.4, fill: true },
                ]
            };

            const slaData = {
                labels: ['KarÅŸÄ±lanan', 'Ä°hlal'],
                datasets: [{ data: [stats?.slaMetCount || 0, stats?.slaBreachedCount || 0], backgroundColor: ['#10B981', '#EF4444'] }]
            };

            const StatCard = ({ icon, label, value, color }) => (
                <div className="card bg-gray-800 p-6 rounded-xl">
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-gray-400 text-sm">{label}</p>
                            <p className="text-3xl font-bold mt-1">{value ?? '-'}</p>
                        </div>
                        <div className={`w-12 h-12 rounded-lg flex items-center justify-center ${color}`}>
                            <i className={`fas ${icon} text-xl`}></i>
                        </div>
                    </div>
                </div>
            );

            return (
                <div>
                    <h1 className="text-2xl font-bold mb-6">ğŸ“Š Dashboard</h1>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <StatCard icon="fa-ticket" label="Toplam Ticket" value={stats?.totalTickets} color="bg-purple-500/20 text-purple-400"/>
                        <StatCard icon="fa-clock" label="AÃ§Ä±k" value={stats?.openTickets} color="bg-green-500/20 text-green-400"/>
                        <StatCard icon="fa-check-circle" label="KapalÄ±" value={stats?.closedTickets} color="bg-blue-500/20 text-blue-400"/>
                        <StatCard icon="fa-star" label="Ort. Rating" value={stats?.averageRating?.toFixed(1)} color="bg-yellow-500/20 text-yellow-400"/>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div className="lg:col-span-2 bg-gray-800 p-6 rounded-xl">
                            <h2 className="font-semibold mb-4">ğŸ“ˆ Son 14 GÃ¼n</h2>
                            <Chart type="line" data={chartData} options={{ responsive: true, plugins: { legend: { labels: { color: '#9CA3AF' } } }, scales: { x: { ticks: { color: '#9CA3AF' } }, y: { ticks: { color: '#9CA3AF' } } } }}/>
                        </div>
                        <div className="bg-gray-800 p-6 rounded-xl">
                            <h2 className="font-semibold mb-4">ğŸ¯ SLA Performans</h2>
                            <Chart type="doughnut" data={slaData} options={{ responsive: true, plugins: { legend: { labels: { color: '#9CA3AF' } } } }}/>
                        </div>
                    </div>

                    <div className="bg-gray-800 p-6 rounded-xl">
                        <h2 className="font-semibold mb-4">ğŸ† Top Staff</h2>
                        <div className="space-y-3">
                            {leaderboard.map((staff, i) => (
                                <div key={staff.userId} className="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg">
                                    <div className="flex items-center gap-3">
                                        <span className="text-2xl">{['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'][i]}</span>
                                        <span>{staff.username}</span>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <span className="text-purple-400">Lv.{staff.level}</span>
                                        <span className="text-green-400">{staff.ticketsClosed} ticket</span>
                                        <span className="text-yellow-400">{staff.averageRating?.toFixed(1)}â­</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // Tickets Page
        function TicketsPage() {
            const { api } = useApi();
            const [tickets, setTickets] = useState([]);
            const [filter, setFilter] = useState('all');
            const [search, setSearch] = useState('');

            useEffect(() => {
                const endpoint = filter === 'all' ? '/api/tickets' : `/api/tickets?status=${filter}`;
                api(endpoint).then(setTickets).catch(console.error);
            }, [filter]);

            const statusColors = { open: 'bg-green-500', claimed: 'bg-yellow-500', closed: 'bg-red-500' };
            const filtered = tickets.filter(t => 
                !search || t.subject?.toLowerCase().includes(search.toLowerCase()) || t.ticketNumber.toString().includes(search)
            );

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold">ğŸ« Ticketlar</h1>
                        <div className="flex gap-4">
                            <input type="text" placeholder="Ara..." value={search} onChange={e => setSearch(e.target.value)}
                                className="px-4 py-2 rounded-lg bg-gray-700 border border-gray-600"/>
                            <select value={filter} onChange={e => setFilter(e.target.value)}
                                className="px-4 py-2 rounded-lg bg-gray-700 border border-gray-600">
                                <option value="all">TÃ¼mÃ¼</option>
                                <option value="open">AÃ§Ä±k</option>
                                <option value="claimed">SahiplenilmiÅŸ</option>
                                <option value="closed">KapalÄ±</option>
                            </select>
                        </div>
                    </div>
                    <div className="bg-gray-800 rounded-xl overflow-hidden">
                        <table className="w-full">
                            <thead className="bg-gray-700">
                                <tr>
                                    <th className="text-left p-4">#</th>
                                    <th className="text-left p-4">Konu</th>
                                    <th className="text-left p-4">Durum</th>
                                    <th className="text-left p-4">Ã–ncelik</th>
                                    <th className="text-left p-4">Tarih</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filtered.slice(0, 50).map(ticket => (
                                    <tr key={ticket.id} className="border-t border-gray-700 hover:bg-gray-700/50">
                                        <td className="p-4">#{ticket.ticketNumber.toString().padStart(4, '0')}</td>
                                        <td className="p-4">{ticket.subject || 'Konu yok'}</td>
                                        <td className="p-4">
                                            <span className={`px-2 py-1 rounded text-xs ${statusColors[ticket.status]} bg-opacity-20`}>{ticket.status}</span>
                                        </td>
                                        <td className="p-4">{['', 'ğŸŸ¢', 'ğŸŸ¡', 'ğŸŸ ', 'ğŸ”´'][ticket.priority]}</td>
                                        <td className="p-4 text-gray-400">{new Date(ticket.createdAt).toLocaleDateString('tr-TR')}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {filtered.length === 0 && <p className="text-center p-8 text-gray-400">Ticket bulunamadÄ±</p>}
                    </div>
                </div>
            );
        }

        // Staff Page
        function StaffPage() {
            const { api } = useApi();
            const [staff, setStaff] = useState([]);

            useEffect(() => {
                api('/api/staff').then(setStaff).catch(console.error);
            }, []);

            return (
                <div>
                    <h1 className="text-2xl font-bold mb-6">ğŸ‘¥ Staff</h1>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {staff.map(s => (
                            <div key={s.id} className="card bg-gray-800 p-6 rounded-xl">
                                <div className="flex items-center gap-4 mb-4">
                                    <div className="w-12 h-12 rounded-full bg-purple-500/20 flex items-center justify-center text-xl">
                                        {s.username?.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <p className="font-semibold">{s.username}</p>
                                        <p className="text-sm text-purple-400">Level {s.level}</p>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div className="bg-gray-700/50 p-3 rounded-lg">
                                        <p className="text-gray-400">XP</p>
                                        <p className="font-bold text-purple-400">{s.xp}</p>
                                    </div>
                                    <div className="bg-gray-700/50 p-3 rounded-lg">
                                        <p className="text-gray-400">Ticketlar</p>
                                        <p className="font-bold text-green-400">{s.ticketsClosed}</p>
                                    </div>
                                    <div className="bg-gray-700/50 p-3 rounded-lg">
                                        <p className="text-gray-400">Rating</p>
                                        <p className="font-bold text-yellow-400">{s.averageRating?.toFixed(1)}â­</p>
                                    </div>
                                    <div className="bg-gray-700/50 p-3 rounded-lg">
                                        <p className="text-gray-400">Seri</p>
                                        <p className="font-bold text-orange-400">{s.currentStreak} ğŸ”¥</p>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // KB Page
        function KBPage() {
            const { api } = useApi();
            const [articles, setArticles] = useState([]);

            useEffect(() => {
                api('/api/kb').then(setArticles).catch(console.error);
            }, []);

            return (
                <div>
                    <h1 className="text-2xl font-bold mb-6">ğŸ“š Bilgi BankasÄ±</h1>
                    <div className="grid gap-4">
                        {articles.map(a => (
                            <div key={a.id} className="card bg-gray-800 p-6 rounded-xl">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <h3 className="font-semibold text-lg">{a.pinned && 'ğŸ“Œ '}{a.title}</h3>
                                        <p className="text-gray-400 mt-2">{a.content?.substring(0, 150)}...</p>
                                    </div>
                                    <div className="flex gap-4 text-sm text-gray-400">
                                        <span>ğŸ‘ï¸ {a.viewCount}</span>
                                        <span>ğŸ‘ {a.helpfulCount}</span>
                                    </div>
                                </div>
                                {a.tags && <div className="mt-4 flex gap-2">{a.tags.split(',').map(t => <span key={t} className="px-2 py-1 bg-purple-500/20 text-purple-300 rounded text-xs">{t.trim()}</span>)}</div>}
                            </div>
                        ))}
                        {articles.length === 0 && <p className="text-center p-8 text-gray-400">HenÃ¼z makale yok</p>}
                    </div>
                </div>
            );
        }

        // Settings Page
        function SettingsPage() {
            const { api } = useApi();
            const [guild, setGuild] = useState(null);

            useEffect(() => {
                api('/api/guild').then(setGuild).catch(console.error);
            }, []);

            const Setting = ({ label, value }) => (
                <div className="flex justify-between p-4 bg-gray-700/50 rounded-lg">
                    <span className="text-gray-400">{label}</span>
                    <span>{value}</span>
                </div>
            );

            return (
                <div>
                    <h1 className="text-2xl font-bold mb-6">âš™ï¸ Ayarlar</h1>
                    {guild && (
                        <div className="bg-gray-800 p-6 rounded-xl space-y-3">
                            <Setting label="Sunucu" value={guild.name}/>
                            <Setting label="Dil" value={guild.locale?.toUpperCase()}/>
                            <Setting label="Timezone" value={guild.timezone}/>
                            <Setting label="Max Ticket/KullanÄ±cÄ±" value={guild.maxTicketsPerUser}/>
                            <Setting label="Otomatik Kapama" value={`${guild.autoCloseHours} saat`}/>
                            <Setting label="SLA" value={guild.slaEnabled ? 'âœ… Aktif' : 'âŒ Deaktif'}/>
                            <Setting label="AI" value={guild.aiEnabled ? 'âœ… Aktif' : 'âŒ Deaktif'}/>
                            <Setting label="Auto-Assign" value={guild.autoAssignEnabled ? `âœ… ${guild.autoAssignMode}` : 'âŒ Deaktif'}/>
                            <Setting label="Ã‡alÄ±ÅŸma Saatleri" value={guild.businessHoursEnabled ? `âœ… ${guild.businessHoursStart}-${guild.businessHoursEnd}` : 'âŒ Deaktif'}/>
                        </div>
                    )}
                </div>
            );
        }

        // Main App
        function App() {
            const { isAuth } = useApi();
            const [page, setPage] = useState('dashboard');

            if (!isAuth) return <LoginPage/>;

            const pages = { dashboard: DashboardPage, tickets: TicketsPage, staff: StaffPage, kb: KBPage, settings: SettingsPage };
            const Page = pages[page] || DashboardPage;

            return (
                <div className="flex">
                    <Sidebar active={page} setActive={setPage}/>
                    <main className="ml-64 flex-1 p-8 min-h-screen">
                        <Page/>
                    </main>
                </div>
            );
        }

        // Render
        ReactDOM.createRoot(document.getElementById('app')).render(
            <ApiProvider><App/></ApiProvider>
        );
    </script>
</body>
</html>
